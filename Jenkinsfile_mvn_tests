pipeline {
    agent any
    stages {
        stage("build-staging") {
            steps {
                script {
                    successJob = 'false'
                    build('STAGING')
                }
            }
        }
        stage('deploy-staging') {
            steps {
                script {
                    deploy('STAGING')
                }
            }
        }
        stage('test-staging') {
            steps {
                script {
                    test('STAGING')
                }
            }
        }
        stage("build-production)") {
            steps {
                script {
                    successJob = 'false'
                    build('PRODUCTION')
                }
            }
        }
        stage('deploy-production)') {
            steps {
                script {
                    deploy('PRODUCTION')
                }
            }
        }
        stage('test-production)') {
            steps {
                script {
                    test('PRODUCTION')
                }
            }
        }
    }
}

def build(String environment) {
    echo "Build on ${environment} was started"
    echo "The build number - ${env.BUILD_NUMBER}"
    sh 'echo  Execution servertime - `date`'
    env.STAGE_STATUS = 'OK'

    sh "docker run -t --entrypoint bash --rm mvn_tests"
    sh "docker exec -d mvn_tests bash send_notification.sh '${environment}' 0"
    sh "docker rm -f mvn_tests"
}

def deploy(String environment) {
    echo "Deploy started on ${environment}"

    echo "${env.STAGE_STATUS}"
}

def test(String environment) {
    echo "Test executed on ${environment}"

    try {
        sh "docker-compose up -d --force-recreate"
        sh "docker run -t --rm --network=test-automation-setup mvn_tests mvn clean test -Dbrowser=chrome -X -DgridURL=selenium-hub:4444"
        sh "docker rm -f selenium-hub"
    }
    catch (exc) {
        echo "Failed on  ${environment} environment"
    }
}